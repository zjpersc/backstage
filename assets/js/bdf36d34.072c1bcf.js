/*! For license information please see bdf36d34.072c1bcf.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[454620],{603905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>f});var r=n(667294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=r.createContext({}),l=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=l(e.components);return r.createElement(c.Provider,{value:t},e.children)},p="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,c=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=l(n),d=a,f=p["".concat(c,".").concat(d)]||p[d]||h[d]||o;return n?r.createElement(f,i(i({ref:t},u),{},{components:n})):r.createElement(f,i({ref:t},u))}));function f(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s[p]="string"==typeof e?e:a,i[1]=s;for(var l=2;l<o;l++)i[l]=n[l];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},822693:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>c,toc:()=>u});n(827378);var r=n(603905);function a(){return a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},a.apply(this,arguments)}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}const i={id:"service-to-service-auth",title:"Service to Service Auth",description:"This section describes how to use service to service authentication, both internally within Backstage plugins and towards external services."},s=void 0,c={unversionedId:"auth/service-to-service-auth",id:"auth/service-to-service-auth",title:"Service to Service Auth",description:"This section describes how to use service to service authentication, both internally within Backstage plugins and towards external services.",source:"@site/../docs/auth/service-to-service-auth.md",sourceDirName:"auth",slug:"/auth/service-to-service-auth",permalink:"/docs/auth/service-to-service-auth",draft:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/auth/service-to-service-auth.md",tags:[],version:"current",frontMatter:{id:"service-to-service-auth",title:"Service to Service Auth",description:"This section describes how to use service to service authentication, both internally within Backstage plugins and towards external services."},sidebar:"docs",previous:{title:"Contributing New Providers",permalink:"/docs/auth/add-auth-provider"},next:{title:"Troubleshooting Auth",permalink:"/docs/auth/troubleshooting"}},l={},u=[{value:"Setup",id:"setup",level:2},{value:"Usage in Backend Plugins",id:"usage-in-backend-plugins",level:2},{value:"Usage in External Callers",id:"usage-in-external-callers",level:2},{value:"Granular Access Control",id:"granular-access-control",level:2}],p={toc:u};function h(e){var{components:t}=e,n=o(e,["components"]);return(0,r.kt)("wrapper",a({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This article describes the steps needed to introduce ",(0,r.kt)("em",{parentName:"p"},"service-to-service auth")," (formerly ",(0,r.kt)("em",{parentName:"p"},"backend-to-backend")," auth).\nThis allows plugin backends to determine whether a given request originates from\na legitimate Backstage plugin (or other external caller), by requiring a special\ntype of service-to-service token which is signed with a shared secret."),(0,r.kt)("p",null,"When enabling this protection on your Backstage backend plugins, for example the\ncatalog, other callers in the ecosystem such as the search indexer and\nscaffolder would need to present a valid token to the catalog to be able to\nrequest its contents."),(0,r.kt)("h2",a({},{id:"setup"}),"Setup"),(0,r.kt)("p",null,"In a newly created Backstage app, the backend is setup up to not require any\nauth at all. This means that generated service-to-service tokens are empty, and\nthat incoming requests are not validated. If you want to enable\nservice-to-service auth, the first step is to switch out the following line in\nyour backend setup at ",(0,r.kt)("inlineCode",{parentName:"p"},"packages/backend/src/index.ts"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",a({parentName:"pre"},{className:"language-ts",metastring:'title="packages/backend/src/index.ts"',title:'"packages/backend/src/index.ts"'}),"/* highlight-remove-next-line */\nconst tokenManager = ServerTokenManager.noop();\n/* highlight-add-next-line */\nconst tokenManager = ServerTokenManager.fromConfig(config, { logger: root });\n")),(0,r.kt)("p",null,"By switching from the no-op ",(0,r.kt)("inlineCode",{parentName:"p"},"ServiceTokenManager")," to one created from config,\nyou enable service-to-service auth for any plugin that implements it. The local\ndevelopment setup will generally not be impacted by this, as temporary keys are\ngenerated under the hood. But for the production setup, this means you must now\nprovide a shared secret that enables your backend plugins to communicate with\neach other."),(0,r.kt)("p",null,"Backstage service-to-service tokens are currently always signed with a single\nsecret key. It needs to be shared across all backend plugins and services that\nones wishes to communicate across. The key can be any base64 encoded secret.\nThe following command can be used to generate such a key in a terminal:"),(0,r.kt)("pre",null,(0,r.kt)("code",a({parentName:"pre"},{className:"language-bash"}),'node -p \'require("crypto").randomBytes(24).toString("base64")\'\n')),(0,r.kt)("p",null,"Then place it in the backend configuration, either as a direct value or\ninjected as an env variable."),(0,r.kt)("pre",null,(0,r.kt)("code",a({parentName:"pre"},{className:"language-yaml"}),"# commonly in your app-config.production.yaml\nbackend:\n  auth:\n    keys:\n      - secret: <the string returned by the above crypto command>\n    # - secret: ${BACKEND_SECRET} - if you want to use an env variable instead\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"NOTE"),": For ease of development, we auto-generate a key for you if you haven't\nconfigured a secret in dev mode. You ",(0,r.kt)("em",{parentName:"p"},"must set your own secret")," in order for\nservice-to-service auth to work in production; the ",(0,r.kt)("inlineCode",{parentName:"p"},"ServiceTokenManager")," will\nthrow an exception in production if it has no keys to work with, which will lead\nto the backend failing to start up."),(0,r.kt)("h2",a({},{id:"usage-in-backend-plugins"}),"Usage in Backend Plugins"),(0,r.kt)("p",null,"There are a few steps if you want to make use of the service-to-service auth in\nyour own backend plugin. First you need to add the ",(0,r.kt)("inlineCode",{parentName:"p"},"TokenManager")," dependency to\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"createRouter")," options. Typically as ",(0,r.kt)("inlineCode",{parentName:"p"},"tokenManager: TokenManager"),". Along\nwith this you'll need to ask users to start providing this new dependency in\ntheir backend setup code."),(0,r.kt)("p",null,"Once the ",(0,r.kt)("inlineCode",{parentName:"p"},"TokenManager")," is available, you use the ",(0,r.kt)("inlineCode",{parentName:"p"},".getToken()")," method to generate\na new token for any outgoing requests towards other Backstage backend plugins.\nThis method should be called for every request that you make; do not store the\ntoken for later use. The ",(0,r.kt)("inlineCode",{parentName:"p"},"TokenManager")," implementations should already cache\ntokens as needed. The returned token should then be added as a ",(0,r.kt)("inlineCode",{parentName:"p"},"Bearer")," token\nfor the upstream request, for example:"),(0,r.kt)("pre",null,(0,r.kt)("code",a({parentName:"pre"},{className:"language-ts"}),"const { token } = await this.tokenManager.getToken();\n\nconst response = await fetch(pluginBackendApiUrl, {\n  method: 'GET',\n  headers: {\n    ...headers,\n    Authorization: `Bearer ${token}`,\n  },\n});\n")),(0,r.kt)("p",null,"To authenticate an incoming request you use the ",(0,r.kt)("inlineCode",{parentName:"p"},".authenticate(token)")," method.\nAt the time of writing this method doesn't return anything, it will simply\nthrow if the token is invalid."),(0,r.kt)("pre",null,(0,r.kt)("code",a({parentName:"pre"},{className:"language-ts"}),"await tokenManager.authenticate(token); // throws if token is invalid\n")),(0,r.kt)("h2",a({},{id:"usage-in-external-callers"}),"Usage in External Callers"),(0,r.kt)("p",null,"If you have enabled server-to-server auth, you may be interested in generating\ntokens in code that is external to Backstage itself. External callers may even\nbe written in other languages than Node.js. This section explains how to generate\na valid token yourself."),(0,r.kt)("p",null,"The token must be a JWT with a ",(0,r.kt)("inlineCode",{parentName:"p"},"HS256")," signature, using the raw base64 decoded\nvalue of the configured key as the secret. It must also have the following payload:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"sub"),': "backstage-server" (only this value supported currently)'),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"exp"),": one hour from the time it was generated, in epoch seconds")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"NOTE: The JWT must encode the ",(0,r.kt)("inlineCode",{parentName:"p"},"alg")," header as a protected header, such as with\n",(0,r.kt)("a",a({parentName:"p"},{href:"https://github.com/panva/jose/blob/main/docs/classes/jwt_sign.SignJWT.md#setprotectedheader"}),"setProtectedHeader"),".")),(0,r.kt)("h2",a({},{id:"granular-access-control"}),"Granular Access Control"),(0,r.kt)("p",null,"We plan to build out the service-to-service auth to be much more powerful in the\nfuture, but before that is done there are a few tricks you can use with the\ncurrent system to harden your deployments. This section assumes that you have\nalready split your backend plugins into more than one backend deployment, in\norder to scale or isolate them."),(0,r.kt)("p",null,"The backend auth configuration has support for providing multiple keys, for\nexample:"),(0,r.kt)("pre",null,(0,r.kt)("code",a({parentName:"pre"},{className:"language-yaml"}),"backend:\n  auth:\n    keys:\n      - secret: my-secret-key-1\n      - secret: my-secret-key-2\n      - secret: my-secret-key-3\n")),(0,r.kt)("p",null,"The first key will be used for signing requests, while all of the keys will be\nused for validation. This means that you can set up an asymmetric configuration\nwhere some backend deployments do not have access to each other."),(0,r.kt)("p",null,"For example, consider the case where we have split up the catalog, scaffolder,\nand search plugin into three separate backend deployments. We can use the\nfollowing configurations to allow both the scaffolder and search plugin to speak\nto the\ncatalog, but not the other way around, and to not allow any communication between\nthe scaffolder and search plugins."),(0,r.kt)("pre",null,(0,r.kt)("code",a({parentName:"pre"},{className:"language-yaml"}),"# catalog config\nbackend:\n  auth:\n    keys:\n      - secret: my-secret-key-catalog\n      - secret: my-secret-key-scaffolder\n      - secret: my-secret-key-search\n\n# scaffolder config\nbackend:\n  auth:\n    keys:\n      - secret: my-secret-key-scaffolder\n\n# search config\nbackend:\n  auth:\n    keys:\n      - secret: my-secret-key-search\n")))}h.isMDXComponent=!0},862525:e=>{var t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable;function a(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;if("0123456789"!==Object.getOwnPropertyNames(t).map((function(e){return t[e]})).join(""))return!1;var r={};return"abcdefghijklmnopqrst".split("").forEach((function(e){r[e]=e})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},r)).join("")}catch(a){return!1}}()?Object.assign:function(e,o){for(var i,s,c=a(e),l=1;l<arguments.length;l++){for(var u in i=Object(arguments[l]))n.call(i,u)&&(c[u]=i[u]);if(t){s=t(i);for(var p=0;p<s.length;p++)r.call(i,s[p])&&(c[s[p]]=i[s[p]])}}return c}},541535:(e,t,n)=>{var r=n(862525),a=60103,o=60106;var i=60109,s=60110,c=60112;var l=60115,u=60116;if("function"==typeof Symbol&&Symbol.for){var p=Symbol.for;a=p("react.element"),o=p("react.portal"),p("react.fragment"),p("react.strict_mode"),p("react.profiler"),i=p("react.provider"),s=p("react.context"),c=p("react.forward_ref"),p("react.suspense"),l=p("react.memo"),u=p("react.lazy")}var h="function"==typeof Symbol&&Symbol.iterator;function d(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var f={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},y={};function g(e,t,n){this.props=e,this.context=t,this.refs=y,this.updater=n||f}function m(){}function k(e,t,n){this.props=e,this.context=t,this.refs=y,this.updater=n||f}g.prototype.isReactComponent={},g.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error(d(85));this.updater.enqueueSetState(this,e,t,"setState")},g.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},m.prototype=g.prototype;var v=k.prototype=new m;v.constructor=k,r(v,g.prototype),v.isPureReactComponent=!0;var b={current:null},w=Object.prototype.hasOwnProperty,O={key:!0,ref:!0,__self:!0,__source:!0};function j(e,t,n){var r,o={},i=null,s=null;if(null!=t)for(r in void 0!==t.ref&&(s=t.ref),void 0!==t.key&&(i=""+t.key),t)w.call(t,r)&&!O.hasOwnProperty(r)&&(o[r]=t[r]);var c=arguments.length-2;if(1===c)o.children=n;else if(1<c){for(var l=Array(c),u=0;u<c;u++)l[u]=arguments[u+2];o.children=l}if(e&&e.defaultProps)for(r in c=e.defaultProps)void 0===o[r]&&(o[r]=c[r]);return{$$typeof:a,type:e,key:i,ref:s,props:o,_owner:b.current}}function T(e){return"object"==typeof e&&null!==e&&e.$$typeof===a}var N=/\/+/g;function x(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function S(e,t,n,r,i){var s=typeof e;"undefined"!==s&&"boolean"!==s||(e=null);var c=!1;if(null===e)c=!0;else switch(s){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case a:case o:c=!0}}if(c)return i=i(c=e),e=""===r?"."+x(c,0):r,Array.isArray(i)?(n="",null!=e&&(n=e.replace(N,"$&/")+"/"),S(i,t,n,"",(function(e){return e}))):null!=i&&(T(i)&&(i=function(e,t){return{$$typeof:a,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(i,n+(!i.key||c&&c.key===i.key?"":(""+i.key).replace(N,"$&/")+"/")+e)),t.push(i)),1;if(c=0,r=""===r?".":r+":",Array.isArray(e))for(var l=0;l<e.length;l++){var u=r+x(s=e[l],l);c+=S(s,t,n,u,i)}else if(u=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=h&&e[h]||e["@@iterator"])?e:null}(e),"function"==typeof u)for(e=u.call(e),l=0;!(s=e.next()).done;)c+=S(s=s.value,t,n,u=r+x(s,l++),i);else if("object"===s)throw t=""+e,Error(d(31,"[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t));return c}function C(e,t,n){if(null==e)return e;var r=[],a=0;return S(e,r,"","",(function(e){return t.call(n,e,a++)})),r}function P(e){if(-1===e._status){var t=e._result;t=t(),e._status=0,e._result=t,t.then((function(t){0===e._status&&(t=t.default,e._status=1,e._result=t)}),(function(t){0===e._status&&(e._status=2,e._result=t)}))}if(1===e._status)return e._result;throw e._result}var _={current:null};function E(){var e=_.current;if(null===e)throw Error(d(321));return e}},827378:(e,t,n)=>{n(541535)}}]);