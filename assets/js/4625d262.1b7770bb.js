/*! For license information please see 4625d262.1b7770bb.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[674777],{603905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>g});var a=n(667294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=a.createContext({}),c=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(i.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,i=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(n),m=r,g=u["".concat(i,".").concat(m)]||u[m]||d[m]||s;return n?a.createElement(g,o(o({ref:t},p),{},{components:n})):a.createElement(g,o({ref:t},p))}));function g(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,o=new Array(s);o[0]=m;var l={};for(var i in t)hasOwnProperty.call(t,i)&&(l[i]=t[i]);l.originalType=e,l[u]="string"==typeof e?e:r,o[1]=l;for(var c=2;c<s;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},226743:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>p});n(827378);var a=n(603905);function r(){return r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},r.apply(this,arguments)}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}const o={id:"k8s",title:"Deploying with Kubernetes",sidebar_label:"Kubernetes",description:"How to deploy Backstage to a Kubernetes cluster"},l=void 0,i={unversionedId:"deployment/k8s",id:"deployment/k8s",title:"Deploying with Kubernetes",description:"How to deploy Backstage to a Kubernetes cluster",source:"@site/../docs/deployment/k8s.md",sourceDirName:"deployment",slug:"/deployment/k8s",permalink:"/docs/deployment/k8s",draft:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/deployment/k8s.md",tags:[],version:"current",frontMatter:{id:"k8s",title:"Deploying with Kubernetes",sidebar_label:"Kubernetes",description:"How to deploy Backstage to a Kubernetes cluster"},sidebar:"docs",previous:{title:"Docker",permalink:"/docs/deployment/docker"},next:{title:"Heroku",permalink:"/docs/deployment/heroku"}},c={},p=[{value:"Testing locally",id:"testing-locally",level:2},{value:"Creating a namespace",id:"creating-a-namespace",level:2},{value:"Creating the PostgreSQL database",id:"creating-the-postgresql-database",level:2},{value:"Creating a PostgreSQL secret",id:"creating-a-postgresql-secret",level:3},{value:"Creating a PostgreSQL persistent volume",id:"creating-a-postgresql-persistent-volume",level:3},{value:"Creating a PostgreSQL deployment",id:"creating-a-postgresql-deployment",level:3},{value:"Creating a PostgreSQL service",id:"creating-a-postgresql-service",level:3},{value:"Creating the Backstage instance",id:"creating-the-backstage-instance",level:2},{value:"Creating a Backstage secret",id:"creating-a-backstage-secret",level:3},{value:"Creating a Backstage deployment",id:"creating-a-backstage-deployment",level:3},{value:"Creating a Backstage service",id:"creating-a-backstage-service",level:3},{value:"Further steps",id:"further-steps",level:2},{value:"Set up a more reliable volume",id:"set-up-a-more-reliable-volume",level:3},{value:"Expose the Backstage service",id:"expose-the-backstage-service",level:3},{value:"Update the Deployment image",id:"update-the-deployment-image",level:3}],u={toc:p};function d(e){var{components:t}=e,n=s(e,["components"]);return(0,a.kt)("wrapper",r({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("a",r({parentName:"p"},{href:"https://kubernetes.io/"}),"Kubernetes")," is a system for deploying, scaling and\nmanaging containerized applications. Backstage is designed to fit this model and\nrun as a stateless application with an external PostgreSQL database."),(0,a.kt)("p",null,"There are many different tools and patterns for Kubernetes clusters, so the best\nway to deploy to an existing Kubernetes setup is ",(0,a.kt)("em",{parentName:"p"},"the same way")," you deploy\neverything else."),(0,a.kt)("p",null,"This guide covers basic Kubernetes definitions needed to get Backstage up and\nrunning in a typical cluster. The object definitions might look familiar, since\nthe Backstage software catalog\n",(0,a.kt)("a",r({parentName:"p"},{href:"/docs/features/software-catalog/descriptor-format"}),"also uses")," the Kubernetes\nobject format for its entity definition files!"),(0,a.kt)("h2",r({},{id:"testing-locally"}),"Testing locally"),(0,a.kt)("p",null,"To test out these concepts locally before deploying to a production Kubernetes\ncluster, first install ",(0,a.kt)("a",r({parentName:"p"},{href:"https://kubernetes.io/docs/tasks/tools/"}),"kubectl"),", the\nKubernetes command-line tool."),(0,a.kt)("p",null,"Next, install ",(0,a.kt)("a",r({parentName:"p"},{href:"https://minikube.sigs.k8s.io/docs/start/"}),"minikube"),". This creates\na single-node Kubernetes cluster on your local machine:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),'# Assumes Mac + Homebrew; see the minikube site for other installations\n$ brew install minikube\n$ minikube start\n\n...\nDone! kubectl is now configured to use "minikube" cluster and "default" namespace by default.\n')),(0,a.kt)("p",null,"Now you can run ",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl")," commands and have changes applied to the minikube\ncluster. You should be able to see the ",(0,a.kt)("inlineCode",{parentName:"p"},"kube-system")," Kubernetes pods running:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"$ kubectl get pods -A\n")),(0,a.kt)("p",null,"When you're done with the tutorial, use ",(0,a.kt)("inlineCode",{parentName:"p"},"minikube stop")," to halt the cluster and\nfree up resources."),(0,a.kt)("h2",r({},{id:"creating-a-namespace"}),"Creating a namespace"),(0,a.kt)("p",null,"Deployments in Kubernetes are commonly assigned to their own\n",(0,a.kt)("a",r({parentName:"p"},{href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/"}),"namespace"),"\nto isolate services in a multi-tenant environment."),(0,a.kt)("p",null,"This can be done through ",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl")," directly:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"$ kubectl create namespace backstage\nnamespace/backstage created\n")),(0,a.kt)("p",null,"Alternatively, create and apply a Namespace definition:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-yaml"}),"# kubernetes/namespace.yaml\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: backstage\n")),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"$ kubectl apply -f kubernetes/namespace.yaml\nnamespace/backstage created\n")),(0,a.kt)("h2",r({},{id:"creating-the-postgresql-database"}),"Creating the PostgreSQL database"),(0,a.kt)("p",null,"Backstage in production uses PostgreSQL as a database. To isolate the database\nfrom Backstage app deployments, we can create a separate Kubernetes deployment\nfor PostgreSQL."),(0,a.kt)("h3",r({},{id:"creating-a-postgresql-secret"}),"Creating a PostgreSQL secret"),(0,a.kt)("p",null,"First, create a Kubernetes Secret for the PostgreSQL username and password. This\nwill be used by both the PostgreSQL database and Backstage deployments:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-yaml"}),"# kubernetes/postgres-secrets.yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: postgres-secrets\n  namespace: backstage\ntype: Opaque\ndata:\n  POSTGRES_USER: YmFja3N0YWdl\n  POSTGRES_PASSWORD: aHVudGVyMg==\n")),(0,a.kt)("p",null,"The data in Kubernetes secrets are base64-encoded. The values can be generated\non the command line:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),'$ echo -n "backstage" | base64\nYmFja3N0YWdl\n')),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Note: Secrets are base64-encoded, but not encrypted. Be sure to enable\n",(0,a.kt)("a",r({parentName:"p"},{href:"https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/"}),"Encryption at Rest"),"\nfor the cluster. For storing secrets in Git, consider\n",(0,a.kt)("a",r({parentName:"p"},{href:"https://learnk8s.io/kubernetes-secrets-in-git"}),"SealedSecrets or other solutions"),".")),(0,a.kt)("p",null,"The secrets can now be applied to the Kubernetes cluster:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"$ kubectl apply -f kubernetes/postgres-secrets.yaml\nsecret/postgres-secrets created\n")),(0,a.kt)("h3",r({},{id:"creating-a-postgresql-persistent-volume"}),"Creating a PostgreSQL persistent volume"),(0,a.kt)("p",null,"PostgreSQL needs a persistent volume to store data; we'll create one along with\na ",(0,a.kt)("inlineCode",{parentName:"p"},"PersistentVolumeClaim"),". In this case, we're claiming the whole volume - but\nclaims can ask for only part of a volume as well."),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-yaml"}),"# kubernetes/postgres-storage.yaml\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: postgres-storage\n  namespace: backstage\n  labels:\n    type: local\nspec:\n  storageClassName: manual\n  capacity:\n    storage: 2G\n  accessModes:\n    - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Retain\n  hostPath:\n    path: '/mnt/data'\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: postgres-storage-claim\n  namespace: backstage\nspec:\n  storageClassName: manual\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 2G\n")),(0,a.kt)("p",null,"This file contains definitions for two different kinds, separated by a line with\na triple dash. This syntax is helpful if you want to consolidate related\nKubernetes definitions in a single file and apply them at the same time."),(0,a.kt)("p",null,"Note the volume ",(0,a.kt)("inlineCode",{parentName:"p"},"type: local"),"; this creates a volume using local disk on\nKubernetes nodes. More likely in a production scenario, you'd want to use a more\nhighly available\n",(0,a.kt)("a",r({parentName:"p"},{href:"https://kubernetes.io/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes"}),"type of PersistentVolume"),"."),(0,a.kt)("p",null,"Apply the storage volume and claim to the Kubernetes cluster:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"$ kubectl apply -f kubernetes/postgres-storage.yaml\npersistentvolume/postgres-storage created\npersistentvolumeclaim/postgres-storage-claim created\n")),(0,a.kt)("h3",r({},{id:"creating-a-postgresql-deployment"}),"Creating a PostgreSQL deployment"),(0,a.kt)("p",null,"Now we can create a Kubernetes Deployment descriptor for the PostgreSQL database\ndeployment itself:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-yaml"}),"# kubernetes/postgres.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: postgres\n  namespace: backstage\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: postgres\n  template:\n    metadata:\n      labels:\n        app: postgres\n    spec:\n      containers:\n        - name: postgres\n          image: postgres:13.2-alpine\n          imagePullPolicy: 'IfNotPresent'\n          ports:\n            - containerPort: 5432\n          envFrom:\n            - secretRef:\n                name: postgres-secrets\n          volumeMounts:\n            - mountPath: /var/lib/postgresql/data\n              name: postgresdb\n      volumes:\n        - name: postgresdb\n          persistentVolumeClaim:\n            claimName: postgres-storage-claim\n")),(0,a.kt)("p",null,"If you're not used to Kubernetes, this is a lot to take in. We're describing a\nDeployment (one or more instances of an application) that we'd like Kubernetes\nto know about in the ",(0,a.kt)("inlineCode",{parentName:"p"},"metadata")," block."),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"spec")," block describes the desired state. Here we've requested Kubernetes\ncreate 1 replica (running instance of PostgreSQL), and to create the replica\nwith the given pod ",(0,a.kt)("inlineCode",{parentName:"p"},"template"),", which again contains Kubernetes metadata and a\ndesired state. The template ",(0,a.kt)("inlineCode",{parentName:"p"},"spec")," shows one container, created from the\n",(0,a.kt)("a",r({parentName:"p"},{href:"https://hub.docker.com/_/postgres"}),"published")," ",(0,a.kt)("inlineCode",{parentName:"p"},"postgres:13.2-alpine")," Docker\nimage."),(0,a.kt)("p",null,"Note the ",(0,a.kt)("inlineCode",{parentName:"p"},"envFrom")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"secretRef")," - this tells Kubernetes to fill environment\nvariables in the container with values from the Secret we created. We've also\nreferenced the volume created for the deployment, and given it the mount path\nexpected by PostgreSQL."),(0,a.kt)("p",null,"Apply the PostgreSQL deployment to the Kubernetes cluster:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"$ kubectl apply -f kubernetes/postgres.yaml\ndeployment.apps/postgres created\n\n$ kubectl get pods --namespace=backstage\nNAME                        READY   STATUS    RESTARTS   AGE\npostgres-56c86b8bbc-66pt2   1/1     Running   0          21s\n")),(0,a.kt)("p",null,"Verify the deployment by connecting to the pod:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"$ kubectl exec -it --namespace=backstage postgres-56c86b8bbc-66pt2 -- /bin/bash\nbash-5.1# psql -U $POSTGRES_USER\npsql (13.2)\nbackstage=# \\q\nbash-5.1# exit\n")),(0,a.kt)("h3",r({},{id:"creating-a-postgresql-service"}),"Creating a PostgreSQL service"),(0,a.kt)("p",null,"The database pod is running, but how does another pod connect to it?"),(0,a.kt)("p",null,"Kubernetes pods are transient - they can be stopped, restarted, or created\ndynamically. Therefore we don't want to try to connect to pods directly, but\nrather create a Kubernetes Service. Services keep track of pods and direct\ntraffic to the right place."),(0,a.kt)("p",null,"The final step for our database is to create the service descriptor:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-yaml"}),"# kubernetes/postgres-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: postgres\n  namespace: backstage\nspec:\n  selector:\n    app: postgres\n  ports:\n    - port: 5432\n")),(0,a.kt)("p",null,"Apply the service to the Kubernetes cluster:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"$ kubectl apply -f kubernetes/postgres-service.yaml\nservice/postgres created\n\n$ kubectl get services --namespace=backstage\nNAME       TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE\npostgres   ClusterIP   10.96.5.103   <none>        5432/TCP   29s\n")),(0,a.kt)("h2",r({},{id:"creating-the-backstage-instance"}),"Creating the Backstage instance"),(0,a.kt)("p",null,"Now that we have PostgreSQL up and ready to store data, we can create the\nBackstage instance. This follows similar steps as the PostgreSQL deployment."),(0,a.kt)("h3",r({},{id:"creating-a-backstage-secret"}),"Creating a Backstage secret"),(0,a.kt)("p",null,"For any Backstage configuration secrets, such as authorization tokens, we can\ncreate a similar Kubernetes Secret as we did\n",(0,a.kt)("a",r({parentName:"p"},{href:"#creating-a-postgresql-secret"}),"for PostgreSQL"),", remembering to base64 encode\nthe values:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-yaml"}),"# kubernetes/backstage-secrets.yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: backstage-secrets\n  namespace: backstage\ntype: Opaque\ndata:\n  GITHUB_TOKEN: VG9rZW5Ub2tlblRva2VuVG9rZW5NYWxrb3ZpY2hUb2tlbg==\n")),(0,a.kt)("p",null,"Apply the secret to the Kubernetes cluster:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"$ kubectl apply -f kubernetes/backstage-secrets.yaml\nsecret/backstage-secrets created\n")),(0,a.kt)("h3",r({},{id:"creating-a-backstage-deployment"}),"Creating a Backstage deployment"),(0,a.kt)("p",null,"To create the Backstage deployment, first create a ",(0,a.kt)("a",r({parentName:"p"},{href:"/docs/deployment/docker"}),"Docker image"),".\nWe'll use this image to create a Kubernetes deployment. For this example, we'll\nuse the standard host build with the frontend bundled and served from the\nbackend."),(0,a.kt)("p",null,"First, create a Kubernetes Deployment descriptor:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-yaml"}),"# kubernetes/backstage.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: backstage\n  namespace: backstage\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: backstage\n  template:\n    metadata:\n      labels:\n        app: backstage\n    spec:\n      containers:\n        - name: backstage\n          image: backstage:1.0.0\n          imagePullPolicy: IfNotPresent\n          ports:\n            - name: http\n              containerPort: 7007\n          envFrom:\n            - secretRef:\n                name: postgres-secrets\n            - secretRef:\n                name: backstage-secrets\n# Uncomment if health checks are enabled in your app:\n# https://backstage.io/docs/plugins/observability#health-checks\n#          readinessProbe:\n#            httpGet:\n#              port: 7007\n#              path: /healthcheck\n#          livenessProbe:\n#            httpGet:\n#              port: 7007\n#              path: /healthcheck\n")),(0,a.kt)("p",null,"For production deployments, the ",(0,a.kt)("inlineCode",{parentName:"p"},"image")," reference will usually be a full URL to\na repository on a container registry (for example, ECR on AWS)."),(0,a.kt)("p",null,"For testing locally with ",(0,a.kt)("inlineCode",{parentName:"p"},"minikube"),", you can point the local Docker daemon to\nthe ",(0,a.kt)("inlineCode",{parentName:"p"},"minikube")," internal Docker registry and then rebuild the image to install\nit:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"$ eval $(minikube docker-env)\n$ yarn build-image --tag backstage:1.0.0\n")),(0,a.kt)("p",null,"There is no special wiring needed to access the PostgreSQL service. Since it's\nrunning on the same cluster, Kubernetes will inject ",(0,a.kt)("inlineCode",{parentName:"p"},"POSTGRES_SERVICE_HOST")," and\n",(0,a.kt)("inlineCode",{parentName:"p"},"POSTGRES_SERVICE_PORT")," environment variables into our Backstage container.\nThese can be used in the Backstage ",(0,a.kt)("inlineCode",{parentName:"p"},"app-config.yaml")," along with the secrets:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-yaml"}),"backend:\n  database:\n    client: pg\n    connection:\n      host: ${POSTGRES_SERVICE_HOST}\n      port: ${POSTGRES_SERVICE_PORT}\n      user: ${POSTGRES_USER}\n      password: ${POSTGRES_PASSWORD}\n")),(0,a.kt)("p",null,"Make sure to rebuild the Docker image after applying ",(0,a.kt)("inlineCode",{parentName:"p"},"app-config.yaml")," changes."),(0,a.kt)("p",null,"Apply this Deployment to the Kubernetes cluster:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"$ kubectl apply -f kubernetes/backstage.yaml\ndeployment.apps/backstage created\n\n$ kubectl get deployments --namespace=backstage\nNAME        READY   UP-TO-DATE   AVAILABLE   AGE\nbackstage   1/1     1            1           1m\npostgres    1/1     1            1           10m\n\n$ kubectl get pods --namespace=backstage\nNAME                                 READY   STATUS    RESTARTS   AGE\nbackstage-54bfcd6476-n2jkm           1/1     Running   0          58s\npostgres-56c86b8bbc-66pt2            1/1     Running   0          9m\n")),(0,a.kt)("p",null,"Beautiful! \ud83c\udf89 The deployment and pod are running in the cluster. If you run into\nany trouble, check the container logs from the pod:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"# -f to tail, <pod> -c <container>\n$ kubectl logs --namespace=backstage -f backstage-54bfcd6476-n2jkm -c backstage\n")),(0,a.kt)("h3",r({},{id:"creating-a-backstage-service"}),"Creating a Backstage service"),(0,a.kt)("p",null,"Like the ",(0,a.kt)("a",r({parentName:"p"},{href:"#creating-a-postgresql-service"}),"PostgreSQL service")," above, we need to\ncreate a Kubernetes Service for Backstage to handle connecting requests to the\ncorrect pods."),(0,a.kt)("p",null,"Create the Kubernetes Service descriptor:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-yaml"}),"# kubernetes/backstage-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: backstage\n  namespace: backstage\nspec:\n  selector:\n    app: backstage\n  ports:\n    - name: http\n      port: 80\n      targetPort: http\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"selector")," here is telling the Service which pods to target, and the port\nmapping translates normal HTTP port 80 to the backend http port (7007) on the\npod."),(0,a.kt)("p",null,"Apply this Service to the Kubernetes cluster:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"$ kubectl apply -f kubernetes/backstage-service.yaml\nservice/backstage created\n")),(0,a.kt)("p",null,"Now we have a fully operational Backstage deployment! \ud83c\udf89 For a ",(0,a.kt)("em",{parentName:"p"},(0,a.kt)("strong",{parentName:"em"},"grand\nreveal")),", you can forward a local port to the service:"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-shell"}),"$ sudo kubectl port-forward --namespace=backstage svc/backstage 80:80\nForwarding from 127.0.0.1:80 -> 7007\n")),(0,a.kt)("p",null,"This shows port 7007 since ",(0,a.kt)("inlineCode",{parentName:"p"},"port-forward")," doesn't ",(0,a.kt)("em",{parentName:"p"},"really")," support services, so\nit cheats by looking up the first pod for a service and connecting to the mapped\npod port."),(0,a.kt)("p",null,"Note that ",(0,a.kt)("inlineCode",{parentName:"p"},"app.baseUrl")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"backend.baseUrl")," in your ",(0,a.kt)("inlineCode",{parentName:"p"},"app-config.yaml")," should\nmatch what we're forwarding here (port omitted in this example since we're using\nthe default HTTP port 80):"),(0,a.kt)("pre",null,(0,a.kt)("code",r({parentName:"pre"},{className:"language-yaml"}),"# app-config.yaml\napp:\n  baseUrl: http://localhost\n\norganization:\n  name: Spotify\n\nbackend:\n  baseUrl: http://localhost\n  listen:\n    port: 7007\n  cors:\n    origin: http://localhost\n")),(0,a.kt)("p",null,"If you're using an ",(0,a.kt)("a",r({parentName:"p"},{href:"/docs/auth/"}),"auth provider"),", it should also have this\naddress configured for the authentication pop-up to work properly."),(0,a.kt)("p",null,"Now you can open a browser on your machine to ",(0,a.kt)("a",r({parentName:"p"},{href:"http://localhost"}),"localhost")," and\nbrowse your Kubernetes-deployed Backstage instance. \ud83d\udea2\ud83d\udea2\ud83d\udea2"),(0,a.kt)("h2",r({},{id:"further-steps"}),"Further steps"),(0,a.kt)("p",null,"This is most of the way to a full production deployment of Backstage on\nKubernetes. There's a few additional steps to that will likely be needed beyond\nthe scope of this document."),(0,a.kt)("h3",r({},{id:"set-up-a-more-reliable-volume"}),"Set up a more reliable volume"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"PersistentVolume")," configured above uses ",(0,a.kt)("inlineCode",{parentName:"p"},"local")," Kubernetes node storage.\nThis should be replaced with a cloud volume, network attached storage, or\nsomething more persistent beyond a Kubernetes node."),(0,a.kt)("h3",r({},{id:"expose-the-backstage-service"}),"Expose the Backstage service"),(0,a.kt)("p",null,"The Kubernetes Service is not exposed for external connections from outside the\ncluster. This is generally done with a Kubernetes\n",(0,a.kt)("a",r({parentName:"p"},{href:"https://kubernetes.io/docs/concepts/services-networking/ingress/"}),"ingress")," or\nan\n",(0,a.kt)("a",r({parentName:"p"},{href:"https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/"}),"external load balancer"),"."),(0,a.kt)("h3",r({},{id:"update-the-deployment-image"}),"Update the Deployment image"),(0,a.kt)("p",null,"To update the Kubernetes deployment to a newly published version of your\nBackstage Docker image, update the image tag reference in ",(0,a.kt)("inlineCode",{parentName:"p"},"backstage.yaml")," and\nthen apply the changes with ",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl apply -f kubernetes/backstage.yaml"),"."),(0,a.kt)("p",null,"For production purposes, this image tag will generally be a full-fledged URL\npointing to a container registry where built Docker images are hosted. This can\nbe hosted internally in your infrastructure, or a managed one offered by a cloud\nprovider."))}d.isMDXComponent=!0},862525:e=>{var t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable;function r(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;if("0123456789"!==Object.getOwnPropertyNames(t).map((function(e){return t[e]})).join(""))return!1;var a={};return"abcdefghijklmnopqrst".split("").forEach((function(e){a[e]=e})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},a)).join("")}catch(r){return!1}}()?Object.assign:function(e,s){for(var o,l,i=r(e),c=1;c<arguments.length;c++){for(var p in o=Object(arguments[c]))n.call(o,p)&&(i[p]=o[p]);if(t){l=t(o);for(var u=0;u<l.length;u++)a.call(o,l[u])&&(i[l[u]]=o[l[u]])}}return i}},541535:(e,t,n)=>{var a=n(862525),r=60103,s=60106;var o=60109,l=60110,i=60112;var c=60115,p=60116;if("function"==typeof Symbol&&Symbol.for){var u=Symbol.for;r=u("react.element"),s=u("react.portal"),u("react.fragment"),u("react.strict_mode"),u("react.profiler"),o=u("react.provider"),l=u("react.context"),i=u("react.forward_ref"),u("react.suspense"),c=u("react.memo"),p=u("react.lazy")}var d="function"==typeof Symbol&&Symbol.iterator;function m(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var g={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},k={};function h(e,t,n){this.props=e,this.context=t,this.refs=k,this.updater=n||g}function b(){}function f(e,t,n){this.props=e,this.context=t,this.refs=k,this.updater=n||g}h.prototype.isReactComponent={},h.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error(m(85));this.updater.enqueueSetState(this,e,t,"setState")},h.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},b.prototype=h.prototype;var y=f.prototype=new b;y.constructor=f,a(y,h.prototype),y.isPureReactComponent=!0;var v={current:null},N=Object.prototype.hasOwnProperty,w={key:!0,ref:!0,__self:!0,__source:!0};function S(e,t,n){var a,s={},o=null,l=null;if(null!=t)for(a in void 0!==t.ref&&(l=t.ref),void 0!==t.key&&(o=""+t.key),t)N.call(t,a)&&!w.hasOwnProperty(a)&&(s[a]=t[a]);var i=arguments.length-2;if(1===i)s.children=n;else if(1<i){for(var c=Array(i),p=0;p<i;p++)c[p]=arguments[p+2];s.children=c}if(e&&e.defaultProps)for(a in i=e.defaultProps)void 0===s[a]&&(s[a]=i[a]);return{$$typeof:r,type:e,key:o,ref:l,props:s,_owner:v.current}}function P(e){return"object"==typeof e&&null!==e&&e.$$typeof===r}var O=/\/+/g;function T(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function C(e,t,n,a,o){var l=typeof e;"undefined"!==l&&"boolean"!==l||(e=null);var i=!1;if(null===e)i=!0;else switch(l){case"string":case"number":i=!0;break;case"object":switch(e.$$typeof){case r:case s:i=!0}}if(i)return o=o(i=e),e=""===a?"."+T(i,0):a,Array.isArray(o)?(n="",null!=e&&(n=e.replace(O,"$&/")+"/"),C(o,t,n,"",(function(e){return e}))):null!=o&&(P(o)&&(o=function(e,t){return{$$typeof:r,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(o,n+(!o.key||i&&i.key===o.key?"":(""+o.key).replace(O,"$&/")+"/")+e)),t.push(o)),1;if(i=0,a=""===a?".":a+":",Array.isArray(e))for(var c=0;c<e.length;c++){var p=a+T(l=e[c],c);i+=C(l,t,n,p,o)}else if(p=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=d&&e[d]||e["@@iterator"])?e:null}(e),"function"==typeof p)for(e=p.call(e),c=0;!(l=e.next()).done;)i+=C(l=l.value,t,n,p=a+T(l,c++),o);else if("object"===l)throw t=""+e,Error(m(31,"[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t));return i}function E(e,t,n){if(null==e)return e;var a=[],r=0;return C(e,a,"","",(function(e){return t.call(n,e,r++)})),a}function j(e){if(-1===e._status){var t=e._result;t=t(),e._status=0,e._result=t,t.then((function(t){0===e._status&&(t=t.default,e._status=1,e._result=t)}),(function(t){0===e._status&&(e._status=2,e._result=t)}))}if(1===e._status)return e._result;throw e._result}var K={current:null};function R(){var e=K.current;if(null===e)throw Error(m(321));return e}},827378:(e,t,n)=>{n(541535)}}]);