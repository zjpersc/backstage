/*! For license information please see 3984ad7a.b6d1d71e.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[287471],{603905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>g});var r=n(667294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},u="mdxType",f={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},y=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(n),y=i,g=u["".concat(l,".").concat(y)]||u[y]||f[y]||a;return n?r.createElement(g,o(o({ref:t},c),{},{components:n})):r.createElement(g,o({ref:t},c))}));function g(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,o=new Array(a);o[0]=y;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:i,o[1]=s;for(var p=2;p<a;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}y.displayName="MDXCreateElement"},162193:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>s,default:()=>f,frontMatter:()=>o,metadata:()=>l,toc:()=>c});n(827378);var r=n(603905);function i(){return i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},i.apply(this,arguments)}function a(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}const o={id:"using-backstage-proxy-within-plugin",title:"Using the Backstage Proxy from Within a Plugin",description:"Guide on how to create a set of API bindings that interface with a backend via the backstage proxy"},s=void 0,l={unversionedId:"tutorials/using-backstage-proxy-within-plugin",id:"tutorials/using-backstage-proxy-within-plugin",title:"Using the Backstage Proxy from Within a Plugin",description:"Guide on how to create a set of API bindings that interface with a backend via the backstage proxy",source:"@site/../docs/tutorials/using-backstage-proxy-within-plugin.md",sourceDirName:"tutorials",slug:"/tutorials/using-backstage-proxy-within-plugin",permalink:"/docs/tutorials/using-backstage-proxy-within-plugin",draft:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/../docs/tutorials/using-backstage-proxy-within-plugin.md",tags:[],version:"current",frontMatter:{id:"using-backstage-proxy-within-plugin",title:"Using the Backstage Proxy from Within a Plugin",description:"Guide on how to create a set of API bindings that interface with a backend via the backstage proxy"},sidebar:"docs",previous:{title:"Switching Backstage from SQLite to PostgreSQL",permalink:"/docs/tutorials/switching-sqlite-postgres"},next:{title:"Migration to Yarn 3",permalink:"/docs/tutorials/yarn-migration"}},p={},c=[{value:"Defining the API client interface",id:"defining-the-api-client-interface",level:2},{value:"Creating the API client",id:"creating-the-api-client",level:2},{value:"Bundling your ApiRef with your plugin",id:"bundling-your-apiref-with-your-plugin",level:2},{value:"Using the API in your components",id:"using-the-api-in-your-components",level:2}],u={toc:c};function f(e){var{components:t}=e,n=a(e,["components"]);return(0,r.kt)("wrapper",i({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This guide walks you through setting up a simple proxy to an existing API that\nis deployed externally to backstage and sending requests to that API from within\na backstage frontend plugin."),(0,r.kt)("p",null,"If your plugin requires access to an API, backstage offers\n",(0,r.kt)("a",i({parentName:"p"},{href:"/docs/plugins/call-existing-api"}),"3 options"),":"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"you can\n",(0,r.kt)("a",i({parentName:"li"},{href:"/docs/plugins/call-existing-api#issuing-requests-directly"}),"access the API directly"),","),(0,r.kt)("li",{parentName:"ol"},"you can create a ",(0,r.kt)("a",i({parentName:"li"},{href:"/docs/plugins/backend-plugin"}),"backend plugin")," if you are\nimplementing the API alongside your frontend plugin"),(0,r.kt)("li",{parentName:"ol"},"you can configure backstage to proxy to an already existing API.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Table of Contents")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",i({parentName:"li"},{href:"#setting-up-the-backstage-proxy"}),"Setting up the backstage proxy")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",i({parentName:"li"},{href:"#calling-an-api-using-the-backstage-proxy"}),"Calling an API using the backstage proxy"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",i({parentName:"li"},{href:"#defining-the-api-client-interface"}),"Defining the API client interface")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",i({parentName:"li"},{href:"#creating-the-api-client"}),"Creating the API client")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",i({parentName:"li"},{href:"#bundling-your-apiref-with-your-plugin"}),"Bundling your ApiRef with your plugin")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",i({parentName:"li"},{href:"#using-your-plugin-in-your-components"}),"Using the API in your components"))))),(0,r.kt)("h1",i({},{id:"setting-up-the-backstage-proxy"}),"Setting up the backstage proxy"),(0,r.kt)("p",null,"Let's say your plugin's API is hosted at ",(0,r.kt)("em",{parentName:"p"},(0,r.kt)("a",i({parentName:"em"},{href:"https://api.myawesomeservice.com/v1"}),"https://api.myawesomeservice.com/v1")),",\nand you want to be able to access it within backstage at\n",(0,r.kt)("inlineCode",{parentName:"p"},"/api/proxy/<your-proxy-uri>"),", and add a default header called\n",(0,r.kt)("inlineCode",{parentName:"p"},"X-Custom-Source"),". You will need to add the following to ",(0,r.kt)("inlineCode",{parentName:"p"},"app-config.yaml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",i({parentName:"pre"},{className:"language-yaml"}),"proxy:\n  '/<your-proxy-uri>':\n    target: https://api.myawesomeservice.com/v1\n    headers:\n      X-Custom-Source: backstage\n")),(0,r.kt)("p",null,"You can find more details about the proxy config options in the\n",(0,r.kt)("a",i({parentName:"p"},{href:"/docs/plugins/proxying"}),"proxying section"),"."),(0,r.kt)("h1",i({},{id:"calling-an-api-using-the-backstage-proxy"}),"Calling an API using the backstage proxy"),(0,r.kt)("p",null,"If you followed the previous steps, you should now be able to access your API by\ncalling ",(0,r.kt)("inlineCode",{parentName:"p"},"${backend-url}/api/proxy/<your-proxy-uri>"),". The reason why\n",(0,r.kt)("inlineCode",{parentName:"p"},"backend-url")," is referenced is because the backstage backend creates and runs\nthe proxy. Backstage is structured in such a way that you could run the\nbackstage frontend independently of the backend. So when calling your API you\nneed to prepend the backend URL to your http call."),(0,r.kt)("p",null,"The recommended pattern for calling out to services is to wrap your calls in a\n",(0,r.kt)("a",i({parentName:"p"},{href:"/docs/api/utility-apis"}),"Utility API"),". This section describes the steps to wrap\nyour API client in a Utility API, which are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"use ",(0,r.kt)("a",i({parentName:"li"},{href:"/docs/reference/core-plugin-api.createapiref"}),(0,r.kt)("inlineCode",{parentName:"a"},"createApiRef"))," to create a\nnew ",(0,r.kt)("a",i({parentName:"li"},{href:"/docs/reference/core-plugin-api.apiref"}),(0,r.kt)("inlineCode",{parentName:"a"},"ApiRef"))),(0,r.kt)("li",{parentName:"ul"},"register an ",(0,r.kt)("a",i({parentName:"li"},{href:"/docs/reference/core-plugin-api.apifactory"}),(0,r.kt)("inlineCode",{parentName:"a"},"ApiFactory"))," with\nyour plugin using\n",(0,r.kt)("a",i({parentName:"li"},{href:"/docs/reference/core-plugin-api.createapifactory"}),(0,r.kt)("inlineCode",{parentName:"a"},"createApiFactory")),". This\nwill wrap your API implementation, associate your ",(0,r.kt)("inlineCode",{parentName:"li"},"ApiRef")," with your\nimplementation and tell backstage how to instantiate it"),(0,r.kt)("li",{parentName:"ul"},"finally, you can use your API in your components by calling\n",(0,r.kt)("a",i({parentName:"li"},{href:"/docs/reference/core-plugin-api.useapi"}),(0,r.kt)("inlineCode",{parentName:"a"},"useApi")))),(0,r.kt)("h2",i({},{id:"defining-the-api-client-interface"}),"Defining the API client interface"),(0,r.kt)("p",null,"Continuing from the previous example, let's assume that\n",(0,r.kt)("em",{parentName:"p"},(0,r.kt)("a",i({parentName:"em"},{href:"https://api.myawesomeservice.com/v1"}),"https://api.myawesomeservice.com/v1"))," has the following endpoints:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",i({parentName:"tr"},{align:"left"}),"Method"),(0,r.kt)("th",i({parentName:"tr"},{align:"left"}),"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",i({parentName:"tr"},{align:"left"}),(0,r.kt)("inlineCode",{parentName:"td"},"GET /users")),(0,r.kt)("td",i({parentName:"tr"},{align:"left"}),"Returns a list of users")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",i({parentName:"tr"},{align:"left"}),(0,r.kt)("inlineCode",{parentName:"td"},"GET /users/{userId}")),(0,r.kt)("td",i({parentName:"tr"},{align:"left"}),"Returns a single user")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",i({parentName:"tr"},{align:"left"}),(0,r.kt)("inlineCode",{parentName:"td"},"DELETE /users/{userId}")),(0,r.kt)("td",i({parentName:"tr"},{align:"left"}),"Deletes a user")))),(0,r.kt)("p",null,"Here is an example definition for this API following backstage's ",(0,r.kt)("inlineCode",{parentName:"p"},"apiRef")," style:"),(0,r.kt)("pre",null,(0,r.kt)("code",i({parentName:"pre"},{className:"language-ts"}),"/* src/api.ts */\nimport { createApiRef } from '@backstage/core-plugin-api';\n\nexport interface User {\n  name: string;\n  email: string;\n}\n\nexport interface MyAwesomeApi {\n  url: string;\n  listUsers: () => Promise<List<User>>;\n  getUser: (userId: string) => Promise<User>;\n  deleteUser: (userId: string) => Promise<boolean>;\n}\n\nexport const myAwesomeApiRef = createApiRef<MyAwesomeApi>({\n  id: 'plugin.my-awesome-api.service',\n});\n")),(0,r.kt)("h2",i({},{id:"creating-the-api-client"}),"Creating the API client"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"myAwesomeApiRef")," is what you will use within backstage to reference the API\nclient in your plugin. The API ref itself is a global singleton object that\nallows you to reference your instantiated API. The actual implementation would\nlook something like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",i({parentName:"pre"},{className:"language-ts"}),"/* src/api.ts */\n\n/* ... */\n\nimport { DiscoveryApi } from '@backstage/core-plugin-api';\n\nexport class MyAwesomeApiClient implements MyAwesomeApi {\n  discoveryApi: DiscoveryApi;\n\n  constructor({discoveryApi}: {discoveryApi: DiscoveryApi}) {\n    this.discoveryApi = discoveryApi;\n  }\n\n  private async fetch<T = any>(input: string, init?: RequestInit): Promise<T> {\n    // As configured previously for the backend proxy\n    const proxyUri = '${await this.discoveryApi.getBaseUrl('proxy')}/<your-proxy-uri>';\n\n    const resp = await fetch(`${proxyUri}${input}`, init);\n    if (!resp.ok) throw new Error(resp);\n    return await resp.json();\n  }\n\n  async listUsers(): Promise<List<User>> {\n    return await this.fetch<List<User>>('/users');\n  }\n\n  async getUser(userId: string): Promise<User> {\n    return await this.fetch<User>(`/users/${userId}`);\n  }\n\n  async deleteUser(userId: string): Promise<boolean> {\n    return await this.fetch<boolean>(\n      `/users/${userId}`,\n      { method: 'DELETE' }\n    );\n  }\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"For more information on the DiscoveryApi check out the\n",(0,r.kt)("a",i({parentName:"p"},{href:"/docs/reference/core-plugin-api.discoveryapi"}),"docs"))),(0,r.kt)("h2",i({},{id:"bundling-your-apiref-with-your-plugin"}),"Bundling your ApiRef with your plugin"),(0,r.kt)("p",null,"The final piece in the puzzle is bundling the ",(0,r.kt)("inlineCode",{parentName:"p"},"myAwesomeApiRef")," with a factory\nfor ",(0,r.kt)("inlineCode",{parentName:"p"},"MyAwesomeApiClient")," objects. This is usually done in the ",(0,r.kt)("inlineCode",{parentName:"p"},"plugin.ts")," file\ninside the plugin's ",(0,r.kt)("inlineCode",{parentName:"p"},"src")," directory. This is an example of what it'd look like,\nassuming you added the previous code in a file called ",(0,r.kt)("inlineCode",{parentName:"p"},"api.ts"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",i({parentName:"pre"},{className:"language-ts"}),"/* src/plugin.ts */\nimport { myAwesomeApiRef, MyAwesomeApiClient } from './api';\nimport {\n  createPlugin,\n  createRouteRef,\n  createApiFactory,\n  createRoutableExtension,\n  createComponentExtension,\n  discoveryApiRef,\n} from '@backstage/core-plugin-api';\n\n//...\n\nexport const myCustomPlugin = createPlugin({\n  id: '<your-plugin-name>',\n\n  // Configure a factory for myAwesomeApiRef\n  apis: [\n    createApiFactory({\n      api: myAwesomeApiRef,\n      deps: { discoveryApi: discoveryApiRef },\n      factory: ({ discoveryApi }) => new MyAwesomeApiClient({ discoveryApi }),\n    }),\n  ],\n});\n")),(0,r.kt)("h2",i({},{id:"using-the-api-in-your-components"}),"Using the API in your components"),(0,r.kt)("p",null,"Now you should be able to access your API using the backstage hook\n",(0,r.kt)("a",i({parentName:"p"},{href:"/docs/reference/core-plugin-api.useapi"}),(0,r.kt)("inlineCode",{parentName:"a"},"useApi"))," from within your plugin code."),(0,r.kt)("pre",null,(0,r.kt)("code",i({parentName:"pre"},{className:"language-ts"}),"/* plugins/my-awesome-plugin/src/components/AwesomeUsersTable.tsx */\nimport { useApi } from '@backstage/core-plugin-api';\nimport { myAwesomeApiRef } from '../../api';\n\nexport const AwesomeUsersTable = () => {\n  const apiClient = useApi(myAwesomeApiRef);\n\n  apiClient.listUsers()\n    .then(\n      ...\n    )\n}\n")))}f.isMDXComponent=!0},862525:e=>{var t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable;function i(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;if("0123456789"!==Object.getOwnPropertyNames(t).map((function(e){return t[e]})).join(""))return!1;var r={};return"abcdefghijklmnopqrst".split("").forEach((function(e){r[e]=e})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},r)).join("")}catch(i){return!1}}()?Object.assign:function(e,a){for(var o,s,l=i(e),p=1;p<arguments.length;p++){for(var c in o=Object(arguments[p]))n.call(o,c)&&(l[c]=o[c]);if(t){s=t(o);for(var u=0;u<s.length;u++)r.call(o,s[u])&&(l[s[u]]=o[s[u]])}}return l}},541535:(e,t,n)=>{var r=n(862525),i=60103,a=60106;var o=60109,s=60110,l=60112;var p=60115,c=60116;if("function"==typeof Symbol&&Symbol.for){var u=Symbol.for;i=u("react.element"),a=u("react.portal"),u("react.fragment"),u("react.strict_mode"),u("react.profiler"),o=u("react.provider"),s=u("react.context"),l=u("react.forward_ref"),u("react.suspense"),p=u("react.memo"),c=u("react.lazy")}var f="function"==typeof Symbol&&Symbol.iterator;function y(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var g={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},m={};function d(e,t,n){this.props=e,this.context=t,this.refs=m,this.updater=n||g}function h(){}function k(e,t,n){this.props=e,this.context=t,this.refs=m,this.updater=n||g}d.prototype.isReactComponent={},d.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error(y(85));this.updater.enqueueSetState(this,e,t,"setState")},d.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},h.prototype=d.prototype;var b=k.prototype=new h;b.constructor=k,r(b,d.prototype),b.isPureReactComponent=!0;var w={current:null},v=Object.prototype.hasOwnProperty,A={key:!0,ref:!0,__self:!0,__source:!0};function N(e,t,n){var r,a={},o=null,s=null;if(null!=t)for(r in void 0!==t.ref&&(s=t.ref),void 0!==t.key&&(o=""+t.key),t)v.call(t,r)&&!A.hasOwnProperty(r)&&(a[r]=t[r]);var l=arguments.length-2;if(1===l)a.children=n;else if(1<l){for(var p=Array(l),c=0;c<l;c++)p[c]=arguments[c+2];a.children=p}if(e&&e.defaultProps)for(r in l=e.defaultProps)void 0===a[r]&&(a[r]=l[r]);return{$$typeof:i,type:e,key:o,ref:s,props:a,_owner:w.current}}function P(e){return"object"==typeof e&&null!==e&&e.$$typeof===i}var x=/\/+/g;function O(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function j(e,t,n,r,o){var s=typeof e;"undefined"!==s&&"boolean"!==s||(e=null);var l=!1;if(null===e)l=!0;else switch(s){case"string":case"number":l=!0;break;case"object":switch(e.$$typeof){case i:case a:l=!0}}if(l)return o=o(l=e),e=""===r?"."+O(l,0):r,Array.isArray(o)?(n="",null!=e&&(n=e.replace(x,"$&/")+"/"),j(o,t,n,"",(function(e){return e}))):null!=o&&(P(o)&&(o=function(e,t){return{$$typeof:i,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(o,n+(!o.key||l&&l.key===o.key?"":(""+o.key).replace(x,"$&/")+"/")+e)),t.push(o)),1;if(l=0,r=""===r?".":r+":",Array.isArray(e))for(var p=0;p<e.length;p++){var c=r+O(s=e[p],p);l+=j(s,t,n,c,o)}else if(c=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=f&&e[f]||e["@@iterator"])?e:null}(e),"function"==typeof c)for(e=c.call(e),p=0;!(s=e.next()).done;)l+=j(s=s.value,t,n,c=r+O(s,p++),o);else if("object"===s)throw t=""+e,Error(y(31,"[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t));return l}function C(e,t,n){if(null==e)return e;var r=[],i=0;return j(e,r,"","",(function(e){return t.call(n,e,i++)})),r}function I(e){if(-1===e._status){var t=e._result;t=t(),e._status=0,e._result=t,t.then((function(t){0===e._status&&(t=t.default,e._status=1,e._result=t)}),(function(t){0===e._status&&(e._status=2,e._result=t)}))}if(1===e._status)return e._result;throw e._result}var U={current:null};function R(){var e=U.current;if(null===e)throw Error(y(321));return e}},827378:(e,t,n)=>{n(541535)}}]);